<!DOCTYPE html>
<html lang="tr">
<head>
  <link rel="stylesheet" href="/index.css" />
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Yükleniyor…</title>
  <link id="site-favicon" rel="icon" href="/favicon.ico" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

  <style>
    :root.theme-light{
      --bg:#fafafa; --surface:#ffffff; --text:#111827; --muted:#6b7280;
      --border:#e5e7eb; --border-soft:#eee; --shadow-sm:0 1px 2px rgba(0,0,0,.06);
      --shadow-md:0 6px 16px rgba(0,0,0,.08);
    }
    :root.theme-dark{
      --bg:#0b1020; --surface:#0f172a; --text:#e5e7eb; --muted:#9ca3af;
      --border:#1f2937; --border-soft:#1f2937;
      --shadow-sm:0 1px 2px rgba(0,0,0,.3); --shadow-md:0 6px 16px rgba(0,0,0,.35);
    }
    body{background:var(--bg); color:var(--text);}
    :root.theme-dark table{ background: var(--surface); }
    :root.theme-dark .auth .btn{ background:#fff!important; color:#000!important; border-color:var(--border); }

    .icon-btn{
      appearance:none; background:#fff; border:1px solid var(--border);
      width:36px; height:36px; padding:0; border-radius:8px;
      display:inline-flex; align-items:center; justify-content:center;
      line-height:0; cursor:pointer; box-shadow:var(--shadow-sm);
    }
    .icon-btn svg{ width:22px; height:22px; display:block; }

    .info{
      background:var(--surface);
      color:var(--text);
      border:1px solid var(--border);
      border-radius:10px;
      padding:10px 12px;
      box-shadow:var(--shadow-sm);
    }

    .leaflet-popup-content .btn{ 
      background:#fff; color:#111; border:1px solid var(--border); 
      padding:.35rem .7rem; border-radius:10px; 
    }
    .leaflet-popup-content .btn.ghost{ background:#fff; color:#111; border-color:var(--border); }
    .leaflet-popup-content .btn.danger{ background:#fff; color:#b91c1c; border-color:#fecaca; }

    .muted{ color:var(--muted); }
    #map{ min-height: 420px; }

    .thumb-grid{
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(110px, 1fr));
      gap:8px;
      margin-top:6px;
    }
    .thumb-tile{
      border:1px solid var(--border);
      background:var(--surface);
      border-radius:10px;
      padding:4px;
      box-shadow:var(--shadow-sm);
      display:flex; align-items:center; justify-content:center;
      max-height:180px;
      overflow:hidden;
    }
    .thumb-tile img, .thumb-tile video{
      width:100%; height:100%; object-fit:cover; border-radius:6px;
      display:block;
    }

    .popup-photos, .popup-videos{
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
      gap:6px;
      margin:.4rem 0;
    }
    .popup-photos a, .popup-videos a{ display:block; }
    .popup-photos img{
      width:100%; height:100px; object-fit:cover; border-radius:8px; border:1px solid var(--border);
      display:block;
    }
    .popup-videos video{
      width:100%; height:120px; object-fit:cover; border-radius:8px; border:1px solid var(--border);
      display:block;
    }

    .modal{ position:fixed; inset:0; background:rgba(0,0,0,.5); display:none; align-items:center; justify-content:center; z-index:9999; }
    .modal.show{ display:flex; }
    .modal .box{ background:var(--surface); border:1px solid var(--border); border-radius:12px; width:min(560px, 92vw); padding:12px; box-shadow:var(--shadow-md); }
    .modal .head{ display:flex; align-items:center; justify-content:space-between; margin-bottom:8px; }
    .modal video, .modal canvas{ width:100%; border-radius:10px; background:#000; }
    .row.gap6{ display:flex; gap:6px; flex-wrap:wrap; align-items:center; }

    .admin-card h3{ margin-top:0; }
    .admin-grid{
      display:grid;
      grid-template-columns: 1fr;
      gap:14px;
    }
    @media (min-width: 980px){
      .admin-grid{
        grid-template-columns: 1fr 1fr;
      }
    }
    table{ width:100%; border-collapse:collapse; }
    th, td{ border:1px solid var(--border); padding:8px; vertical-align:top; position:relative; }
    th{ background:var(--surface); text-align:left; }
    body.role-supervisor.supervisor-mode-form #admin-card{ display: none !important; }

    /* Tab Navigation */
    .tab-nav{
      display:flex; gap:4px; margin-bottom:12px; border-bottom:2px solid var(--border);
    }
    .tab-btn{
      padding:8px 16px; background:transparent; border:none; cursor:pointer;
      font-weight:600; color:var(--muted); border-bottom:2px solid transparent;
      margin-bottom:-2px; transition: all .2s;
    }
    .tab-btn.active{ color:var(--primary); border-bottom-color:var(--primary); }
    .tab-btn:hover{ color:var(--text); }
    .tab-content{ display:none; }
    .tab-content.active{ display:block; }

    /* Filter Dropdown - Z-INDEX YÜKSEK */
/* Filter Dropdown - Z-INDEX ÇOK YÜKSEK */
    .filter-dropdown{
      position:absolute; top:100%; left:0; background:var(--surface);
      border:1px solid var(--border); border-radius:8px; padding:8px;
      box-shadow:var(--shadow-md); z-index:99999; min-width:200px;
      max-height:300px; overflow-y:auto; display:none;
    }
/* Filter Options Container - Sabit Boyut */
    .filter-options-container{
      min-height: 150px;
      max-height: 200px;
      overflow-y: auto;
      margin-top: 4px;
      scrollbar-width: thin;
    }
    .filter-options-container::-webkit-scrollbar{ width:8px; }
    .filter-options-container::-webkit-scrollbar-thumb{ 
      background:#d1d5db; 
      border-radius:6px; 
      border:1px solid var(--surface); 
    }
    
    /* Tablo header position */
    th{ position: relative; }
    .filter-dropdown.show{ display:block; }
    .filter-search{ 
      width:100%; padding:6px 8px; margin-bottom:8px; 
      border:1px solid var(--border); border-radius:6px; 
      font-size:13px;
    }
    .filter-option{ 
      display:flex; align-items:center; gap:6px; 
      padding:4px 0; cursor:pointer; font-size:13px;
    }
    .filter-option input{ cursor:pointer; }
    .filter-option:hover{
      background: rgba(37, 99, 235, 0.08);
      border-radius: 4px;
    }
    .filter-icon{
      cursor:pointer; margin-left:4px; opacity:.5; font-size:12px;
      display:inline-block; width:16px; height:16px; text-align:center;
      user-select: none; transition: opacity 0.2s ease;
    }
    .filter-icon:hover{ opacity:1; }
    .filter-icon.active{ opacity:1; color:var(--primary); font-weight:700; }

    /* Pagination */
    .pagination{
      display:flex; align-items:center; justify-content:space-between;
      padding:8px 12px; border-top:1px solid var(--border);
    }
    .pagination-info{ font-size:13px; color:var(--muted); }
    .pagination-controls{ display:flex; gap:4px; }
    .pagination-controls button{
      padding:4px 8px; border:1px solid var(--border); background:var(--surface);
      border-radius:6px; cursor:pointer; font-size:13px; transition: all 0.2s ease;
    }
    .pagination-controls button:hover:not(:disabled){
      background: var(--primary); color: #fff; border-color: var(--primary);
    }
    .pagination-controls button:disabled{ opacity:.5; cursor:not-allowed; }
    .pagination-controls button.active{ background:var(--primary); color:#fff; border-color:var(--primary); }

    /* Dark Mode Filter Support */
    :root.theme-dark .filter-dropdown{
      background: var(--surface);
      border-color: var(--border);
    }
    :root.theme-dark .filter-search{
      background: #1f2937;
      color: var(--text);
      border-color: var(--border);
    }
    :root.theme-dark .filter-option:hover{
      background: rgba(37, 99, 235, 0.15);
    }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="brand">
        <img id="site-logo" alt="logo" class="hidden" />
        <h1 id="site-title"></h1>
      </div>
      <div class="auth">
        <button id="btn-theme-toggle" class="icon-btn" type="button" aria-label="Tema"></button>
        <span id="whoami" class="hidden"></span>
        <button id="btn-open-login" class="btn">Giriş yap</button>
        <button id="btn-logout" class="btn hidden">Çıkış</button>
      </div>
    </div>
  </header>

  <main>
    <section class="card">
      <div id="map-wrap" class="map-wrap">
        <div id="map"></div>
        <div id="map-legend" class="map-legend" aria-label="Harita lejantı">
          <h5>Lejant</h5>
          <div class="legend-row">
            <span class="legend-icon" aria-hidden="true">
              <svg viewBox="0 0 24 24" aria-hidden="true">
                <path fill="#10b981" d="M12 2a7 7 0 0 0-7 7c0 5 7 13 7 13s7-8 7-13a7 7 0 0 0-7-7zm0 9.5a2.5 2.5 0 1 1 0-5 2.5 2.5 0 0 1 0 5z"/>
              </svg>
            </span>
            <span>Benim olay</span>
          </div>
          <div class="legend-row">
            <span class="legend-icon" aria-hidden="true">
              <svg viewBox="0 0 24 24" aria-hidden="true">
                <path fill="#3b82f6" d="M12 2a7 7 0 0 0-7 7c0 5 7 13 7 13s7-8 7-13a7 7 0 0 0-7-7zm0 9.5a2.5 2.5 0 1 1 0-5 2.5 2.5 0 0 1 0 5z"/>
              </svg>
            </span>
            <span>Diğer olay</span>
          </div>
          <div class="sep" style="height:1px;background:var(--border-soft);margin:6px 0;"></div>
          <div class="legend-row">
            <span class="legend-icon" title="Sadece foto" aria-hidden="true">
              <svg viewBox="0 0 24 24" aria-hidden="true">
                <path fill="#6b7280" d="M9 4h6l1.2 2H20a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h3.8L9 4zM12 18a5 5 0 1 0 0-10 5 5 0 0 0 0 10zm0-2.2a2.8 2.8 0 1 1 0-5.6 2.8 2.8 0 0 1 0 5.6z"/>
              </svg>
            </span>
            <span>Sadece foto</span>
          </div>
          <div class="legend-row">
            <span class="legend-icon" title="Sadece video" aria-hidden="true">
              <svg viewBox="0 0 24 24" aria-hidden="true">
                <path fill="#6b7280" d="M3 7h11a2 2 0 0 1 2 2v1.4l4-2.3a1 1 0 0 1 1.5.86v7.08a1 1 0 0 1-1.5.86l-4-2.3V15a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V9a2 2 0 0 1 2-2z"/>
              </svg>
            </span>
            <span>Sadece video</span>
          </div>
          <div class="legend-row">
            <span class="legend-icon" title="Foto + video" aria-hidden="true">
              <svg viewBox="0 0 24 24" aria-hidden="true">
                <circle cx="12" cy="12" r="10" fill="#6b7280"/>
                <path d="M10 8l6 4-6 4V8z" fill="#ffffff"/>
              </svg>
            </span>
            <span>Foto + Video</span>
          </div>
        </div>
      </div>
      <div class="muted" style="margin-top:8px;">
        Mevcut olaylar haritada gösterilir. Yeni olay eklemek için haritadan bir konum seçin veya enlem/boylamı elle girin.
      </div>
    </section>

    <aside class="stack">
      <!-- GİRİŞ -->
      <section id="login-card" class="card">
        <h3>Giriş</h3>
        <div id="login-error" class="error hidden"></div>
        <label for="login-user">Kullanıcı adı veya e-posta</label>
        <input id="login-user" type="text" placeholder="kullanıcı adı veya e-posta"
               autocomplete="off" autocapitalize="none" autocorrect="off" spellcheck="false" />
        <label for="login-pass">Şifre</label>
        <div class="input-wrap">
          <input id="login-pass" type="password" placeholder="••••••••" autocomplete="new-password" />
          <button type="button" class="eye-btn" data-eye="login-pass" title="Göster/Gizle">👁</button>
        </div>
        <div id="totp-block" class="hidden">
          <label for="login-totp">Doğrulama Kodu (2FA)</label>
          <input id="login-totp" type="text" inputmode="numeric" pattern="[0-9]*" placeholder="123456" autocomplete="one-time-code" />
          <div class="muted">Admin/Supervisor için zorunlu.</div>
        </div>
        <button id="btn-login" class="btn primary" style="margin-top:10px;">Giriş yap</button>
        <div class="muted" style="margin-top:8px;">
          <a href="#" id="goto-forgot">Şifremi unuttum</a> •
          Hesabın yok mu? <a href="#" id="toggle-register">Kayıt ol</a>
        </div>
      </section>

      <!-- KAYIT -->
      <section id="register-card" class="card hidden">
        <h3>Kayıt Ol</h3>
        <div id="register-error" class="error hidden"></div>
        <div id="allowed-domain" class="muted hidden"></div>
        <label for="reg-username">Kullanıcı adı</label>
        <input id="reg-username" type="text" placeholder="kullanıcı adı" autocomplete="off" />
        <label for="reg-email">E-posta</label>
        <input id="reg-email" type="email" placeholder="ornek@alanadi.com" autocomplete="off" />
        <label for="reg-pass">Şifre</label>
        <div class="input-wrap">
          <input id="reg-pass" type="password" placeholder="en az 8 karakter, büyük/küçük harf ve noktalama içermeli" autocomplete="new-password" />
          <button type="button" class="eye-btn" data-eye="reg-pass" title="Göster/Gizle">👁</button>
        </div>
        <div class="row">
          <div><label for="reg-name">Ad</label><input id="reg-name" type="text" autocomplete="off" placeholder="Adınız" /></div>
          <div><label for="reg-surname">Soyad</label><input id="reg-surname" type="text" autocomplete="off" placeholder="Soyadınız" /></div>
        </div>
        <button id="btn-register" class="btn primary" style="margin-top:10px;">Kayıt ol</button>
        <div class="muted" style="margin-top:8px;"><a href="#" id="toggle-login">Zaten hesabın var mı? Giriş yap</a></div>
      </section>

      <!-- ŞİFRE SIFIRLA -->
      <section id="forgot-card" class="card hidden">
        <h3>Şifre Sıfırla</h3>
        <div class="muted" style="margin:-2px 0 6px;">3 adımda şifrenizi yenileyin: E-posta → Kod → Yeni Şifre</div>
        <div id="forgot-error" class="error hidden"></div>
        <div id="fg-email-row">
          <label for="fg-email">E-posta</label>
          <input id="fg-email" type="email" placeholder="kayıtlı e-posta" autocomplete="email" />
          <div class="inline" style="gap:8px; margin:8px 0;">
            <button id="btn-forgot-start" class="btn">Kod Gönder</button>
          </div>
        </div>
        <div id="fg-code-row" class="hidden">
          <label for="fg-code">Doğrulama Kodu</label>
          <input id="fg-code" type="text" inputmode="numeric" pattern="[0-9]*" placeholder="123456" autocomplete="one-time-code" />
          <div class="inline" style="gap:8px; margin-top:8px;">
            <button id="btn-forgot-verify" class="btn">Kodu Doğrula</button>
          </div>
        </div>
        <div id="fg-pass1-row" class="hidden">
          <label for="fg-pass1">Yeni Şifre</label>
          <input id="fg-pass1" type="password" placeholder="Yeni şifre" autocomplete="new-password" />
        </div>
        <div id="fg-pass2-row" class="hidden">
          <label for="fg-pass2">Yeni Şifre (Tekrar)</label>
          <input id="fg-pass2" type="password" placeholder="Yeni şifre tekrar" autocomplete="new-password" />
          <div class="inline" style="gap:8px; margin-top:8px;">
            <button id="btn-forgot-reset" class="btn primary">Şifreyi Sıfırla</button>
          </div>
        </div>
        <div class="inline" style="gap:8px; margin-top:10px;">
          <a href="#" id="back-to-login" class="btn ghost">Giriş sayfası</a>
        </div>
      </section>

      <!-- OLAY FORMU -->
      <section id="olay-card" class="card hidden">
        <div class="pill" id="role-pill">USER</div>
        <h3>Olay Bildirim Formu</h3>
        <div id="error-message" class="error hidden"></div>
        <label for="olay_turu">Olay Türü</label>
        <select id="olay_turu"><option value="">-- Seçiniz --</option></select>
        <label for="aciklama">Açıklama</label>
        <textarea id="aciklama" rows="4" placeholder="Açıklama girin..."></textarea>
        <div class="row">
          <div><label for="lat">Enlem</label><input id="lat" type="text" placeholder="Haritadan seçin" /></div>
          <div><label for="lng">Boylam</label><input id="lng" type="text" placeholder="Haritadan seçin" /></div>
        </div>
        <div class="inline" style="gap:8px; margin:8px 0;">
          <button id="btn-add-photo" class="btn">📷 Kamera (Foto)</button>
          <button id="btn-add-video" class="btn">🎥 Kamera (Video)</button>
          <input id="file-photo" type="file" accept="image/*" capture="environment" class="hidden" />
          <input id="file-video" type="file" accept="video/*" capture="environment" class="hidden" />
        </div>
        <div class="thumbs">
          <div id="photo-list" class="thumb-grid"></div>
          <div id="video-list" class="thumb-grid" style="margin-top:4px;"></div>
        </div>
        <div class="inline" style="gap:8px; margin-top:6px;">
          <button type="button" id="btn-use-location" class="btn">Konumumu kullan</button>
          <button type="button" id="btn-stop-live" class="btn ghost hidden">Takibi durdur</button>
        </div>
        <div class="inline" style="gap:10px; margin-top:8px;">
          <button type="button" id="submit-btn" class="btn primary">Gönder</button>
          <button type="button" id="cancel-edit-btn" class="btn ghost hidden">İptal</button>
          <span id="edit-hint" class="muted hidden">Düzenleme: <span id="edit-id"></span></span>
        </div>
      </section>

      <!-- YÖNETİM PANELİ -->
      <section id="admin-card" class="card admin-card hidden">
        <h3>Yönetim Paneli</h3>
        
        <!-- Tab Navigation -->
        <div class="tab-nav">
          <button class="tab-btn active" data-tab="types-tab">Olay Türleri</button>
          <button class="tab-btn" data-tab="users-tab">Kullanıcılar</button>
          <button class="tab-btn" data-tab="events-tab">Olaylar</button>
        </div>

        <!-- Olay Türleri Tab -->
        <div id="types-tab" class="tab-content active">
          <div class="panel">
            <div class="row" style="gap:8px; margin:6px 0;">
              <input id="new-type-name" type="text" placeholder="Yeni olay türü adı" />
              <button id="btn-add-type" class="btn">Ekle</button>
            </div>
            <div class="table-wrap" style="overflow:auto;">
              <table id="types-table">
                <thead>
                  <tr>
                    <th>
                      Ad
                      <span class="filter-icon" data-column="name" title="Filtrele">▼</span>
                      <div class="filter-dropdown" data-column="name"></div>
                    </th>
                    <th>
                      Ekleyen
                      <span class="filter-icon" data-column="creator" title="Filtrele">▼</span>
                      <div class="filter-dropdown" data-column="creator"></div>
                    </th>
                    <th>İşlem</th>
                  </tr>
                </thead>
                <tbody id="type-tbody"></tbody>
              </table>
            </div>
            <div class="pagination">
              <div class="pagination-info" id="types-pagination-info"></div>
              <div class="pagination-controls" id="types-pagination-controls"></div>
            </div>
          </div>
        </div>

        <!-- Kullanıcılar Tab -->
        <div id="users-tab" class="tab-content">
          <div class="panel">
            <div class="table-wrap" style="overflow:auto;">
<table id="users-table">
                <thead>
                  <tr>
                    <th>
                      Kullanıcı Adı
                      <span class="filter-icon" data-column="username" title="Filtrele">▼</span>
                      <div class="filter-dropdown" data-column="username"></div>
                    </th>
                    <th>
                      Rol
                      <span class="filter-icon" data-column="role" title="Filtrele">▼</span>
                      <div class="filter-dropdown" data-column="role"></div>
                    </th>
                    <th>
                      E-posta
                      <span class="filter-icon" data-column="email" title="Filtrele">▼</span>
                      <div class="filter-dropdown" data-column="email"></div>
                    </th>
                    <th>
                      E-posta Doğrulandı
                      <span class="filter-icon" data-column="verified" title="Filtrele">▼</span>
                      <div class="filter-dropdown" data-column="verified"></div>
                    </th>
                    <th>İşlem</th>
                  </tr>
                </thead>
                <tbody id="user-tbody"></tbody>
              </table>
            </div>
            <div class="pagination">
              <div class="pagination-info" id="users-pagination-info"></div>
              <div class="pagination-controls" id="users-pagination-controls"></div>
            </div>
          </div>
        </div>

<!-- Olaylar Tab -->
        <div id="events-tab" class="tab-content">
          <div class="panel">
            <div class="table-wrap" style="overflow:auto;">
              <table id="events-table">
                <thead>
                  <tr>
                    <th>
                      Tür
                      <span class="filter-icon" data-column="type" title="Filtrele">▼</span>
                      <div class="filter-dropdown" data-column="type"></div>
                    </th>
                    <th>Açıklama</th>
                    <th>
                      Ekleyen
                      <span class="filter-icon" data-column="creator" title="Filtrele">▼</span>
                      <div class="filter-dropdown" data-column="creator"></div>
                    </th>
                    <th>
                      Fotoğraf
                      <span class="filter-icon" data-column="photo" title="Filtrele">▼</span>
                      <div class="filter-dropdown" data-column="photo"></div>
                    </th>
                    <th>
                      Video
                      <span class="filter-icon" data-column="video" title="Filtrele">▼</span>
                      <div class="filter-dropdown" data-column="video"></div>
                    </th>
                    <th>
                      Eklenme Tarihi
                      <span class="filter-icon" data-column="date" title="Filtrele">▼</span>
                      <div class="filter-dropdown" data-column="date"></div>
                    </th>
                    <th>İşlem</th>
                  </tr>
                </thead>
                <tbody id="event-tbody"></tbody>
              </table>
            </div>
            <div class="pagination">
              <div class="pagination-info" id="events-pagination-info"></div>
              <div class="pagination-controls" id="events-pagination-controls"></div>
            </div>
          </div>
        </div>
      </section>
    </aside>
  </main>
  <!-- FOTO KAMERA MODALI -->
  <div id="photo-modal" class="modal" aria-hidden="true">
    <div class="box">
      <div class="head">
        <h4>Fotoğraf Çek</h4>
        <button id="pm-close" class="btn ghost" type="button">Kapat</button>
      </div>
      <video id="pm-video" playsinline autoplay muted></video>
      <canvas id="pm-canvas" class="hidden"></canvas>
      <div class="row gap6" style="margin-top:8px;">
        <button id="pm-capture" class="btn primary" type="button">Çek</button>
        <button id="pm-retake" class="btn ghost hidden" type="button">Tekrar</button>
        <button id="pm-use" class="btn hidden" type="button">Kullan</button>
        <button id="pm-gallery" class="btn" type="button">Galeri</button>
      </div>
    </div>
  </div>

  <!-- VİDEO KAMERA MODALI -->
<!-- VİDEO KAMERA MODALI -->
  <div id="video-modal" class="modal" aria-hidden="true">
    <div class="box">
      <div class="head">
        <h4>Video Kaydet</h4>
        <button id="vm-close" class="btn ghost" type="button">Kapat</button>
      </div>
      <video id="vm-preview" playsinline autoplay></video>
      <div class="row gap6" style="margin-top:8px;">
        <button id="vm-start" class="btn primary" type="button">Başlat</button>
        <button id="vm-stop" class="btn danger hidden" type="button">Durdur</button>
      </div>
    </div>
  </div>

  <!-- OLAY TÜRÜ GÜNCELLEME MODALI -->
  <div id="update-type-modal" class="modal" aria-hidden="true">
    <div class="box">
      <div class="head">
        <h4>Olay Türünü Güncelle</h4>
        <button id="update-type-cancel-btn" class="btn ghost" type="button">İptal</button>
      </div>
      <div style="margin:12px 0;">
        <label for="update-type-input">Yeni Olay Türü Adı</label>
        <input id="update-type-input" type="text" placeholder="Olay türü adı" autocomplete="off" />
      </div>
      <div class="row gap6" style="margin-top:8px;">
        <button id="update-type-save-btn" class="btn primary" type="button">Kaydet</button>
      </div>
    </div>
  </div>

  <script>
  (function(){
    if (!('serviceWorker' in navigator)) return;
    const swCode = `
      let authToken = null; self.addEventListener('message', (e) => {
        if (e && e.data && e.data.type === 'SET_TOKEN') {
          authToken = e.data.token || null;
        }
      });
      function shouldIntercept(url) {
        try {
          const u = new URL(url);
          if (u.origin !== self.location.origin) return false;
          if (/^\/uploads\//.test(u.pathname)) return true;
          if (/^\/api\/olay\/\d+\/(photo|video)(\/.*)?$/.test(u.pathname)) return true;
          return false;
        } catch { return false; }
      }
      self.addEventListener('fetch', (event) => {
        const req = event.request;
        if (!shouldIntercept(req.url) || !authToken) return;
        event.respondWith((async () => {
          const headers = new Headers(req.headers);
          headers.set('Authorization', 'Bearer ' + authToken);
          const proxied = new Request(req, { headers });
          try { return await fetch(proxied); } catch { return fetch(req); }
        })());
      });
    `;
    const blob = new Blob([swCode], { type: 'text/javascript' });
    const swUrl = URL.createObjectURL(blob);
    navigator.serviceWorker.register(swUrl).then(async (reg) => {
      const sendToken = () => {
        try {
          const token = localStorage.getItem('auth_token') || localStorage.getItem('token') || '';
          (reg.active || reg.waiting)?.postMessage({ type: 'SET_TOKEN', token });
        } catch {}
      };
      if (reg.active) sendToken();
      navigator.serviceWorker.ready.then(() => sendToken());
      window.addEventListener('storage', (ev) => {
        if (ev.key === 'auth_token' || ev.key === 'token') sendToken();
      });
      const _setItem = localStorage.setItem.bind(localStorage);
      localStorage.setItem = function(k, v){
        _setItem(k, v);
        if (k === 'auth_token' || k === 'token') { try { sendToken(); } catch {} }
      };
    }).catch(() => {});
  })();
  </script>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    (function(){
      if (!window.L) return;
      const WORLD_BOUNDS = L.latLngBounds(L.latLng(-85, -180), L.latLng(85, 180));
      const _map = L.map;
      L.map = function(id, options){
        const o = Object.assign({},
          { maxZoom: 18, minZoom: 2, worldCopyJump: false, maxBounds: WORLD_BOUNDS, maxBoundsViscosity: 1.0 },
          (options||{})
        );
        const m = _map.call(this, id, o);
        try { m.setMaxBounds(WORLD_BOUNDS); } catch {}
        return m;
      };
      const _tile = L.tileLayer;
      L.tileLayer = function(url, options){
        const o = Object.assign({}, { noWrap: true, bounds: WORLD_BOUNDS }, (options||{}));
        return _tile.call(this, url, o);
      };
    })();
  </script>
  <script>
    (function(){
      const legends = Array.from(document.querySelectorAll('.map-legend'));
      if (legends.length > 1) {
        legends.slice(0, -1).forEach(el => el.parentNode && el.parentNode.removeChild(el));
      }
    })();
  </script>
  <script defer src="/app.js"></script>
</body>
</html>